import{A as m,e as b,g as D,h as g,k as v,m as A,n as E,p as R,r as n,t,u as f,v as u,x as c,y as d,z as l}from"./chunk-PG33KLFS.js";import{P as U,U as h,a as P,b as w,s as y}from"./chunk-TZCEURQS.js";var k=class p{auth=h(b);firestore=h(E);currentUser$=D(this.auth);currentUserRole$=this.currentUser$.pipe(y(async r=>{if(!r)return null;try{return(await f(t(this.firestore,"usuarios",r.uid))).data()?.rol||"usuario"}catch(s){return console.error("Error al obtener rol:",s),"usuario"}}));getAllProgrammers(){let r=n(this.firestore,"programmers");return R(r,{idField:"uid"})}async registrarAdmin(r,s,o){let i=(await g(this.auth,r,s)).user.uid,e={uid:i,email:r,nombre:o,rol:"admin",fechaRegistro:new Date,activo:!0,permiso_crear_usuarios:!0,permiso_editar_usuarios:!0,permiso_eliminar_usuarios:!0,permiso_gestionar_contenido:!0};return await d(t(this.firestore,"usuarios",i),e),e}async registrarProgramador(r,s,o){let i=(await g(this.auth,r,s)).user.uid,e={uid:i,email:r,nombre:o.nombre,rol:"programador",especialidad:o.especialidad,descripcion:o.descripcion,fotoPerfil:o.fotoPerfil,contacto:o.contacto,redesSociales:o.redesSociales,habilidades:o.habilidades,proyectos:[],fechaRegistro:new Date,activo:!0};return await d(t(this.firestore,"usuarios",i),e),e}async registrarUsuarioExterno(r,s,o){let i=(await g(this.auth,r,s)).user.uid,e={uid:i,email:r,nombre:o,rol:"usuario",fechaRegistro:new Date,activo:!0};return await d(t(this.firestore,"usuarios",i),e),e}async login(r,s){return await v(this.auth,r,s)}async logout(){return await A(this.auth)}async obtenerDatosUsuarioActual(){let r=this.auth.currentUser;return r&&(await f(t(this.firestore,"usuarios",r.uid))).data()||null}async obtenerUsuarioPorId(r){return(await f(t(this.firestore,"usuarios",r))).data()||null}async obtenerUsuarioPorEmail(r){try{let s=c(n(this.firestore,"usuarios"),m("email","==",r)),o=await u(s);return o.empty?null:o.docs[0].data()}catch(s){return console.error("Error al buscar usuario por email:",s),null}}async asignarRolPorEmail(r,s){let o=c(n(this.firestore,"usuarios"),m("email","==",r)),a=await u(o);if(a.empty)return!1;let i=a.docs[0].ref;return await l(i,{rol:s}),!0}async crearOActualizarUsuario(r,s){let o=t(this.firestore,"usuarios",r);await d(o,w(P({},s),{uid:r}),{merge:!0})}async obtenerTodosProgramadores(){let r=c(n(this.firestore,"usuarios"),m("rol","==","programador"));return(await u(r)).docs.map(o=>o.data())}async obtenerUsuariosPorRol(r){let s=c(n(this.firestore,"usuarios"),m("rol","==",r));return(await u(s)).docs.map(a=>a.data())}async editarProgramador(r,s){await l(t(this.firestore,"usuarios",r),s)}async editarUsuario(r,s){await l(t(this.firestore,"usuarios",r),s)}async desactivarUsuario(r){await l(t(this.firestore,"usuarios",r),{activo:!1})}async esAdmin(){return(await this.obtenerDatosUsuarioActual())?.rol==="admin"}async esProgramador(){return(await this.obtenerDatosUsuarioActual())?.rol==="programador"}async esUsuarioExterno(){return(await this.obtenerDatosUsuarioActual())?.rol==="usuario"}async asignarRolesBulk(r){let s=[];for(let o of r)try{let a=c(n(this.firestore,"usuarios"),m("email","==",o.email)),i=await u(a);if(i.empty){s.push({email:o.email,ok:!1,message:"No existe documento en Firestore"});continue}let e=i.docs[0].ref;await l(e,{rol:o.rol}),s.push({email:o.email,ok:!0,message:"Rol actualizado"})}catch(a){console.error("Error asignando rol bulk:",a),s.push({email:o.email,ok:!1,message:String(a?.message||a)})}return s}static \u0275fac=function(s){return new(s||p)};static \u0275prov=U({token:p,factory:p.\u0275fac,providedIn:"root"})};export{k as a};
